<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":"ture","trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="1. Background &amp; IntroPersonally speaking, I have not paid any attention to such a device until I noticed a product made by an Estonian Company, 7Senses.  SuperBrain 1 - 7Sense  This SuperBrain is">
<meta property="og:type" content="article">
<meta property="og:title" content="Navigation Device for Visually Impaired People">
<meta property="og:url" content="http://example.com/2025/07/24/Guide-Cap-Project/index.html">
<meta property="og:site_name" content="Yiwei&#39;s Blog">
<meta property="og:description" content="1. Background &amp; IntroPersonally speaking, I have not paid any attention to such a device until I noticed a product made by an Estonian Company, 7Senses.  SuperBrain 1 - 7Sense  This SuperBrain is">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/SuperBrain1.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/SuperBrainLite.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/The%20rendered%20image%20of%20the%20project.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/Main%20box%20for%20vibration%20Motor.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/The%20Box%20for%20the%20mainboard.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_75.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_77.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_79.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_112.jpg">
<meta property="og:image" content="file:///C:/Users/Evan/AppData/Roaming/marktext/images/2025-07-24-16-50-06-%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_114.jpg">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_103.jpg">
<meta property="article:published_time" content="2025-07-24T04:17:54.000Z">
<meta property="article:modified_time" content="2025-11-10T02:48:19.538Z">
<meta property="article:author" content="Yw-Zheng">
<meta property="article:tag" content="Invention">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/SuperBrain1.jpg">

<link rel="canonical" href="http://example.com/2025/07/24/Guide-Cap-Project/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>
<script data-goatcounter="https://1-wei.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
  <title>Navigation Device for Visually Impaired People | Yiwei's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Yiwei's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/07/24/Guide-Cap-Project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Yw-Zheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yiwei's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Navigation Device for Visually Impaired People
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-07-24 12:17:54" itemprop="dateCreated datePublished" datetime="2025-07-24T12:17:54+08:00">2025-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-11-10 10:48:19" itemprop="dateModified" datetime="2025-11-10T10:48:19+08:00">2025-11-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Projects/" itemprop="url" rel="index"><span itemprop="name">Projects</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="1-Background-Intro"><a href="#1-Background-Intro" class="headerlink" title="1. Background & Intro"></a>1. Background &amp; Intro</h2><p>Personally speaking, I have not paid any attention to such a device until I noticed a product made by an Estonian Company, 7Senses. </p>
<p><a target="_blank" rel="noopener" href="https://7sense.ee/superbrain-1/">SuperBrain 1 - 7Sense</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/SuperBrain1.jpg" title="" alt="" width="251"><img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/SuperBrainLite.jpg" alt="" width="249"></p>
<p>This SuperBrain is intriguing and revolutionary, according to their opinion. In my own opinion, the information density of haptic feeling is far greater than that of hearing or other senses. Some groups focus on “Taking to the” device, which is difficult to use in some noisy environments. <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1yA8meGEoG/">NUS2024 SWS3025 AIoT Intelligent White Cane</a></p>
<p>However, the price of SuperBarin is too high for common people to afford. So, I decided to design a cheaper version </p>
<h2 id="2-How-I-made-it"><a href="#2-How-I-made-it" class="headerlink" title="2. How I made it"></a>2. How I made it</h2><img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/The%20rendered%20image%20of%20the%20project.jpg" alt="" width="478" data-align="center">

<p>At the very beginning, I used an AI painting program to render a structure of the cap to meet the requirements. After that, I made a list of components required. </p>
<table>
<thead>
<tr>
<th>Name of Components</th>
<th>Number</th>
</tr>
</thead>
<tbody><tr>
<td>5V, 2000mAh battery</td>
<td>2</td>
</tr>
<tr>
<td>ESP32S3 Development Board</td>
<td>2</td>
</tr>
<tr>
<td>Vibration Motor</td>
<td>7</td>
</tr>
<tr>
<td>Laser Radar</td>
<td>1</td>
</tr>
<tr>
<td>Cane</td>
<td>1</td>
</tr>
</tbody></table>
<p>The table above lists the main components I used. Other minor components (e.g., MOSFETs, soldering tools) are omitted for brevity</p>
<p>The general principle is that the Radar, which is fixed on the cane, will detect the obstacles in the surroundings and give the data back to the cap through Bluetooth Low Energy (BLE). The ESP32 board will control the motors inside the cap to vibrate. The intensity of vibration represents the distance between the user and the obstacle. PWM controls the motor vibration intensity by modulating the power supply frequency.</p>
<p>Based on the design above, I start my job from the cap first:<img src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/Main%20box%20for%20vibration%20Motor.png" title="" alt="" data-align="center"></p>
<img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/The%20Box%20for%20the%20mainboard.png" alt="" data-align="center" width="1087">

<p>First of all, I designed an extension board to allow the ESP32 and the motors to communicate. There are 7 interfaces on the board that connect to 7 motors. The 7 motors correspond to 7 directions on the cap.</p>
<p>Second, I modelled a container to put the devices in. After that, I printed these things out.<img src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_75.jpg" title="" alt="" data-align="center"><img src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_77.jpg" title="" alt="" data-align="center"></p>
<img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_79.jpg" alt="" data-align="center" width="795">

<div>
    <center>Installing the components...</center>
</div>

<div>
    <center> </center>
</div>

<img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_112.jpg" alt="" data-align="center" width="750">

<div>
    <center>The Left View of the Cap</center>
</div>

<p>The cap is modified from a head mount for a camera. The vacant place for the action camera is used to fix the battery and the box of the mainboard. The motors connected by wires will be stuck on the head mount. </p>
<img title="" src="file:///C:/Users/Evan/AppData/Roaming/marktext/images/2025-07-24-16-50-06-微信图片_20250708173950_114.jpg" alt="" data-align="center" width="584">

<div>
    <center>The front view of the cap</center>
</div>

<p>The cane design is as follows. Similarly, the radar will be installed on the cane, at the height of the knees. The radar module will rotate so that it can detect obstacles in all directions. Then the output will be sent to another ESP32 to be processed and transferred to the cap.</p>
<p>The mounting arm is a part of a selfie stick; however, I found that the size is unbelievably suitable for my invention.</p>
<img title="" src="https://cdn.jsdelivr.net/gh/Yiwei-Zheng/img-storage/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20250708173950_103.jpg" alt="" data-align="center" width="803">

<div>
    <center>Some Tissue is added to increase the friction</center>
</div>

<h3 id="Now-all-the-hardware-is-ready-It-is-time-for-coding"><a href="#Now-all-the-hardware-is-ready-It-is-time-for-coding" class="headerlink" title="Now, all the hardware is ready. It is time for coding."></a>Now, all the hardware is ready. It is time for coding.</h3><ol>
<li><p>First of all, we should finish the code logics on the cane, which contains the LiDAR and an ESP32: </p>
  <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"BLEDevice.h"</span></span></span><br><span class="line"><span class="comment">//#include "BLEScan.h"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// The remote service we wish to connect to.</span></span><br><span class="line"><span class="function"><span class="type">static</span> BLEUUID <span class="title">serviceUUID</span><span class="params">(<span class="string">"4fafc201-1fb5-459e-8fcc-c5c9c331914b"</span>)</span></span>;</span><br><span class="line"><span class="comment">// The characteristic of the remote service we are interested in.</span></span><br><span class="line"><span class="function"><span class="type">static</span> BLEUUID <span class="title">charUUID</span><span class="params">(<span class="string">"beb5483e-36e1-4688-b7f5-ea07361b26a8"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> boolean doConnect = <span class="literal">false</span>;</span><br><span class="line"><span class="type">static</span> boolean connected = <span class="literal">false</span>;</span><br><span class="line"><span class="type">static</span> boolean doScan = <span class="literal">false</span>;</span><br><span class="line"><span class="type">static</span> BLERemoteCharacteristic *pRemoteCharacteristic;</span><br><span class="line"><span class="type">static</span> BLEAdvertisedDevice *myDevice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Use FreeRTOS queue instead of global variables</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;freertos/queue.h&gt;</span></span></span><br><span class="line">QueueHandle_t ble_data_queue = <span class="built_in">xQueueCreate</span>(<span class="number">10</span>, <span class="built_in">sizeof</span>(<span class="type">float</span>) * <span class="number">2</span>); <span class="comment">// Stores [distance, angle]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. CHANGE these to match your wiring</span></span><br><span class="line"><span class="comment">// IGNORE pins absent from your Lidar model (often EN, PWM)</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_EN = <span class="number">47</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar EN pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_RX = <span class="number">20</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar RX pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_TX = <span class="number">21</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar TX pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_PWM = <span class="number">19</span>;<span class="comment">// ESP32S3 GPIO connected to Lidar PWM pin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YDLIDAR_X3_PRO</span></span><br><span class="line"></span><br><span class="line"><span class="function">HardwareSerial <span class="title">LidarSerial</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SERIAL_MONITOR_BAUD = <span class="number">115200</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> LIDAR_PWM_FREQ = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_PWM_BITS = <span class="number">11</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_PWM_CHANNEL = <span class="number">2</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> LIDAR_SERIAL_RX_BUF_LEN = <span class="number">1024</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> PRINT_EVERY_NTH_POINT = <span class="number">2</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> HEX_DUMP_WIDTH = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create a buffer large enough to store two floats</span></span><br><span class="line">  <span class="type">uint8_t</span> dataBuffer[<span class="number">2</span> * <span class="built_in">sizeof</span>(<span class="type">float</span>)];</span><br><span class="line">  <span class="type">uint8_t</span> dataBufferFlag=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> received_data[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"lds_all_models.h"</span></span></span><br><span class="line"></span><br><span class="line">LDS *lidar;</span><br><span class="line"><span class="type">uint16_t</span> hex_dump_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupLidar</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">  lidar = <span class="keyword">new</span> <span class="built_in">LDS_YDLIDAR_X3_PRO</span>();</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  lidar-&gt;<span class="built_in">setScanPointCallback</span>(lidar_scan_point_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setPacketCallback</span>(lidar_packet_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setSerialWriteCallback</span>(lidar_serial_write_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setSerialReadCallback</span>(lidar_serial_read_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setMotorPinCallback</span>(lidar_motor_pin_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setInfoCallback</span>(lidar_info_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setErrorCallback</span>(lidar_error_callback);</span><br><span class="line"></span><br><span class="line">  LidarSerial.<span class="built_in">begin</span>(lidar-&gt;<span class="built_in">getSerialBaudRate</span>(), SERIAL_8N1, LIDAR_GPIO_TX, LIDAR_GPIO_RX);</span><br><span class="line"></span><br><span class="line">  lidar-&gt;<span class="built_in">init</span>();</span><br><span class="line">  <span class="comment">//lidar-&gt;stop();</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printByteAsHex</span><span class="params">(<span class="type">uint8_t</span> b)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (b &lt; <span class="number">16</span>)</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">'0'</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(b, HEX);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printBytesAsHex</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> * buffer, <span class="type">uint16_t</span> length)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (length == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; length; i++) {</span><br><span class="line">    <span class="built_in">printByteAsHex</span>(buffer[i]);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lidar_serial_read_callback</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_SERIAL_IN</span></span><br><span class="line">  <span class="type">int</span> ch = LidarSerial.<span class="built_in">read</span>();</span><br><span class="line">  <span class="keyword">if</span> (ch != <span class="number">-1</span>) {</span><br><span class="line">    <span class="keyword">if</span> (hex_dump_pos++ % HEX_DUMP_WIDTH == <span class="number">0</span>)</span><br><span class="line">      Serial.<span class="built_in">println</span>();</span><br><span class="line">    <span class="built_in">printByteAsHex</span>(ch);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> ch;</span><br><span class="line">  <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> LidarSerial.<span class="built_in">read</span>();</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">lidar_serial_write_callback</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> * buffer, <span class="type">size_t</span> length)</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_SERIAL_OUT</span></span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">'&gt;'</span>);</span><br><span class="line">  <span class="built_in">printBytesAsHex</span>(buffer, length);</span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> LidarSerial.<span class="built_in">write</span>(buffer, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_scan_point_callback</span><span class="params">(<span class="type">float</span> angle_deg, <span class="type">float</span> distance_mm, <span class="type">float</span> quality,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">bool</span> scan_completed)</span> </span>{</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (scan_completed) {</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Serial.print("Scan completed; scans-per-second ");</span></span><br><span class="line">    <span class="comment">// Serial.println(lidar-&gt;getCurrentScanFreqHz());</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i % PRINT_EVERY_NTH_POINT == <span class="number">0</span>) {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(angle_deg&gt;=<span class="number">90</span>&amp;&amp;angle_deg&lt;=<span class="number">270</span>)</span><br><span class="line">    {</span><br><span class="line">      <span class="type">float</span> data[<span class="number">2</span>] = {distance_mm, angle_deg};</span><br><span class="line">      <span class="built_in">xQueueSendToBack</span>(ble_data_queue, &amp;data, <span class="number">0</span>); <span class="comment">// Non-blocking write;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">          <span class="comment">// Copy two floats to the buffer</span></span><br><span class="line">  <span class="comment">// memcpy(dataBuffer, &amp;distance_mm, sizeof(float));</span></span><br><span class="line">  <span class="comment">// memcpy(dataBuffer + sizeof(float), &amp;angle_deg, sizeof(float));</span></span><br><span class="line">  <span class="comment">// dataBufferFlag=1;</span></span><br><span class="line">  <span class="comment">// pRemoteCharacteristic-&gt;writeValue(dataBuffer, sizeof(dataBuffer));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the characteristic's value to be the array of bytes that is actually a string.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Serial.print(i);</span></span><br><span class="line">    <span class="comment">// Serial.print(' ');</span></span><br><span class="line">    <span class="comment">// Serial.print(distance_mm);</span></span><br><span class="line">    <span class="comment">// Serial.print(' ');</span></span><br><span class="line">    <span class="comment">// Serial.println(angle_deg);</span></span><br><span class="line">  }</span><br><span class="line">  i++;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_motor_pin_callback</span><span class="params">(<span class="type">float</span> value, LDS::<span class="type">lds_pin_t</span> lidar_pin)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pin = (lidar_pin == LDS::LDS_MOTOR_EN_PIN) ? LIDAR_GPIO_EN : LIDAR_GPIO_PWM;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(pin);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">pinIDToString</span>(lidar_pin));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">" mode set to "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(lidar-&gt;<span class="built_in">pinStateToString</span>((LDS::<span class="type">lds_pin_state_t</span>) <span class="built_in">int</span>(value)));</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value &lt;= (<span class="type">float</span>)LDS::DIR_INPUT) {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure pin direction</span></span><br><span class="line">    <span class="keyword">if</span> (value == (<span class="type">float</span>)LDS::DIR_OUTPUT_PWM) {</span><br><span class="line"></span><br><span class="line">      <span class="meta">#<span class="keyword">if</span> ESP_IDF_VERSION_MAJOR &lt; 5</span></span><br><span class="line">      <span class="built_in">ledcSetup</span>(LIDAR_PWM_CHANNEL, LIDAR_PWM_FREQ, LIDAR_PWM_BITS);</span><br><span class="line">      <span class="built_in">ledcAttachPin</span>(pin, LIDAR_PWM_CHANNEL);</span><br><span class="line">      <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">ledcAttachChannel</span>(pin, LIDAR_PWM_FREQ, LIDAR_PWM_BITS, LIDAR_PWM_CHANNEL))</span><br><span class="line">        Serial.<span class="built_in">println</span>(<span class="string">"lidar_motor_pin_callback() ledcAttachChannel() error"</span>);</span><br><span class="line">      <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    } <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">pinMode</span>(pin, (value == (<span class="type">float</span>)LDS::DIR_INPUT) ? INPUT : OUTPUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value &lt; (<span class="type">float</span>)LDS::VALUE_PWM) {</span><br><span class="line">    <span class="comment">// Set constant output</span></span><br><span class="line">    <span class="comment">// TODO invert PWM as needed</span></span><br><span class="line">    <span class="built_in">digitalWrite</span>(pin, (value == (<span class="type">float</span>)LDS::VALUE_HIGH) ? HIGH : LOW);</span><br><span class="line"></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"PWM value set to "</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set PWM duty cycle</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> INVERT_PWM_PIN</span></span><br><span class="line">    value = <span class="number">1</span> - value;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pwm_value = ((<span class="number">1</span>&lt;&lt;LIDAR_PWM_BITS)<span class="number">-1</span>)*value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> ESP_IDF_VERSION_MAJOR &lt; 5</span></span><br><span class="line">    <span class="built_in">ledcWrite</span>(LIDAR_PWM_CHANNEL, pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">ledcWriteChannel</span>(LIDAR_PWM_CHANNEL, pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_info_callback</span><span class="params">(LDS::<span class="type">info_t</span> code, String info)</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR info "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">infoCodeToString</span>(code));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">": "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(info);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_error_callback</span><span class="params">(LDS::<span class="type">result_t</span> code, String aux_info)</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR error "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">resultCodeToString</span>(code));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">": "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(aux_info);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_packet_callback</span><span class="params">(<span class="type">uint8_t</span> * packet, <span class="type">uint16_t</span> length, <span class="type">bool</span> scan_completed)</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_PACKETS</span></span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"Packet callback, length="</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(length);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", scan_completed="</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(scan_completed);</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">notifyCallback</span><span class="params">(BLERemoteCharacteristic *pBLERemoteCharacteristic, <span class="type">uint8_t</span> *pData, <span class="type">size_t</span> length, <span class="type">bool</span> isNotify)</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"Notify callback for characteristic "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(pBLERemoteCharacteristic-&gt;<span class="built_in">getUUID</span>().<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">" of data length "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(length);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"data: "</span>);</span><br><span class="line">  Serial.<span class="built_in">write</span>(pData, length);</span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClientCallback</span> : <span class="keyword">public</span> BLEClientCallbacks {</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onConnect</span><span class="params">(BLEClient *pclient)</span> </span>{}</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onDisconnect</span><span class="params">(BLEClient *pclient)</span> </span>{</span><br><span class="line">    connected = <span class="literal">false</span>;</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">"onDisconnect"</span>);</span><br><span class="line">  }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">connectToServer</span><span class="params">()</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"Forming a connection to "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(myDevice-&gt;<span class="built_in">getAddress</span>().<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">  BLEClient *pClient = BLEDevice::<span class="built_in">createClient</span>();</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">" - Created client"</span>);</span><br><span class="line"></span><br><span class="line">  pClient-&gt;<span class="built_in">setClientCallbacks</span>(<span class="keyword">new</span> <span class="built_in">MyClientCallback</span>());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Connect to the remote BLE Server.</span></span><br><span class="line">  pClient-&gt;<span class="built_in">connect</span>(myDevice);  <span class="comment">// if you pass BLEAdvertisedDevice instead of address, it will be recognized type of peer device address (public or private)</span></span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">" - Connected to server"</span>);</span><br><span class="line">  pClient-&gt;<span class="built_in">setMTU</span>(<span class="number">128</span>);  <span class="comment">//set client to request maximum MTU from server (default is 23 otherwise)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Obtain a reference to the service we are after in the remote BLE server.</span></span><br><span class="line">  BLERemoteService *pRemoteService = pClient-&gt;<span class="built_in">getService</span>(serviceUUID);</span><br><span class="line">  <span class="keyword">if</span> (pRemoteService == <span class="literal">nullptr</span>) {</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"Failed to find our service UUID: "</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(serviceUUID.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    pClient-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">" - Found our service"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Obtain a reference to the characteristic in the service of the remote BLE server.</span></span><br><span class="line">  pRemoteCharacteristic = pRemoteService-&gt;<span class="built_in">getCharacteristic</span>(charUUID);</span><br><span class="line">  <span class="keyword">if</span> (pRemoteCharacteristic == <span class="literal">nullptr</span>) {</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"Failed to find our characteristic UUID: "</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(charUUID.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    pClient-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">" - Found our characteristic"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the value of the characteristic.</span></span><br><span class="line">  <span class="keyword">if</span> (pRemoteCharacteristic-&gt;<span class="built_in">canRead</span>()) {</span><br><span class="line">    String value = pRemoteCharacteristic-&gt;<span class="built_in">readValue</span>();</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"The characteristic value was: "</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(value.<span class="built_in">c_str</span>());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pRemoteCharacteristic-&gt;<span class="built_in">canNotify</span>()) {</span><br><span class="line">    pRemoteCharacteristic-&gt;<span class="built_in">registerForNotify</span>(notifyCallback);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  connected = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Scan for BLE servers and find the first one that advertises the service we are looking for.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyAdvertisedDeviceCallbacks</span> : <span class="keyword">public</span> BLEAdvertisedDeviceCallbacks {</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called for each advertising BLE server.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onResult</span><span class="params">(BLEAdvertisedDevice advertisedDevice)</span> </span>{</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"BLE Advertised Device found: "</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(advertisedDevice.<span class="built_in">toString</span>().<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// We have found a device, let us now see if it contains the service we are looking for.</span></span><br><span class="line">    <span class="keyword">if</span> (advertisedDevice.<span class="built_in">haveServiceUUID</span>() &amp;&amp; advertisedDevice.<span class="built_in">isAdvertisingService</span>(serviceUUID)) {</span><br><span class="line"></span><br><span class="line">      BLEDevice::<span class="built_in">getScan</span>()-&gt;<span class="built_in">stop</span>();</span><br><span class="line">      myDevice = <span class="keyword">new</span> <span class="built_in">BLEAdvertisedDevice</span>(advertisedDevice);</span><br><span class="line">      doConnect = <span class="literal">true</span>;</span><br><span class="line">      doScan = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    }  <span class="comment">// Found our server</span></span><br><span class="line">  }  <span class="comment">// onResult</span></span><br><span class="line">};  <span class="comment">// MyAdvertisedDeviceCallbacks</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">begin</span>(<span class="number">115200</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">"Starting Arduino BLE Client application..."</span>);</span><br><span class="line">  BLEDevice::<span class="built_in">init</span>(<span class="string">"ESP32S3 CLIENT"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Retrieve a Scanner and set the callback we want to use to be informed when we</span></span><br><span class="line">  <span class="comment">// have detected a new device.  Specify that we want active scanning and start the</span></span><br><span class="line">  <span class="comment">// scan to run for 5 seconds.</span></span><br><span class="line">  BLEScan *pBLEScan = BLEDevice::<span class="built_in">getScan</span>();</span><br><span class="line">  pBLEScan-&gt;<span class="built_in">setAdvertisedDeviceCallbacks</span>(<span class="keyword">new</span> <span class="built_in">MyAdvertisedDeviceCallbacks</span>());</span><br><span class="line">  pBLEScan-&gt;<span class="built_in">setInterval</span>(<span class="number">100</span>);</span><br><span class="line">  pBLEScan-&gt;<span class="built_in">setWindow</span>(<span class="number">50</span>);</span><br><span class="line">  pBLEScan-&gt;<span class="built_in">setActiveScan</span>(<span class="literal">true</span>);</span><br><span class="line">  pBLEScan-&gt;<span class="built_in">start</span>(<span class="number">10</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">setupLidar</span>();</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR model "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">getModelName</span>());</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", baud rate "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">getSerialBaudRate</span>());</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", TX GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(LIDAR_GPIO_TX);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", RX GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(LIDAR_GPIO_RX);</span><br><span class="line"></span><br><span class="line">  LDS::<span class="type">result_t</span> result = lidar-&gt;<span class="built_in">start</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"startLidar() result: "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(lidar-&gt;<span class="built_in">resultCodeToString</span>(result));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}  <span class="comment">// End of setup.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This is the Arduino main loop function.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the flag "doConnect" is true then we have scanned for and found the desired</span></span><br><span class="line">  <span class="comment">// BLE Server with which we wish to connect.  Now we connect to it.  Once we are</span></span><br><span class="line">  <span class="comment">// connected we set the connected flag to be true.</span></span><br><span class="line">  <span class="keyword">if</span> (doConnect == <span class="literal">true</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">connectToServer</span>()) {</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">"We are now connected to the BLE Server."</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">"We have failed to connect to the server; there is nothing more we will do."</span>);</span><br><span class="line">    }</span><br><span class="line">    doConnect = <span class="literal">false</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we are connected to a peer BLE Server, update the characteristic each time we are reached</span></span><br><span class="line">  <span class="comment">// with the current time since boot.</span></span><br><span class="line">  <span class="keyword">if</span> (connected) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">xQueueReceive</span>(ble_data_queue, &amp;received_data, <span class="number">0</span>) == pdTRUE) {</span><br><span class="line">      pRemoteCharacteristic-&gt;<span class="built_in">writeValue</span>((<span class="type">uint8_t</span>*)received_data, <span class="built_in">sizeof</span>(received_data));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    lidar-&gt;<span class="built_in">loop</span>();</span><br><span class="line">  } <span class="keyword">else</span> <span class="keyword">if</span> (doScan) {</span><br><span class="line">    BLEDevice::<span class="built_in">getScan</span>()-&gt;<span class="built_in">start</span>(<span class="number">0</span>);  <span class="comment">// this is just example to start scan after disconnect, most likely there is better way to do it in arduino</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="built_in">delay</span>(<span class="number">1</span>);  <span class="comment">// Delay a millisecond between loops.</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">}  <span class="comment">// End of loop</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Then is the part for the head device:</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;BLEDevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;BLEUtils.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;BLEServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVICE_UUID        <span class="string">"4fafc201-1fb5-459e-8fcc-c5c9c331914b"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHARACTERISTIC_UUID <span class="string">"beb5483e-36e1-4688-b7f5-ea07361b26a8"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. CHANGE these to match your wiring</span></span><br><span class="line"><span class="comment">// IGNORE pins absent from your Lidar model (often EN, PWM)</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_EN = <span class="number">19</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar EN pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_RX = <span class="number">16</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar RX pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_TX = <span class="number">15</span>; <span class="comment">// ESP32S3 GPIO connected to Lidar TX pin</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_GPIO_PWM = <span class="number">17</span>;<span class="comment">// ESP32S3 GPIO connected to Lidar PWM pin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE1_PIN 35</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE2_PIN 36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE3_PIN 37</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE4_PIN 38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE5_PIN 39</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE6_PIN 40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SHAKE7_PIN 41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FREQ 2000 <span class="comment">// 频率</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESOLUTION 8 <span class="comment">// 分辨率</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YDLIDAR_X3_PRO</span></span><br><span class="line"><span class="function">HardwareSerial <span class="title">LidarSerial</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> SERIAL_MONITOR_BAUD = <span class="number">115200</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint32_t</span> LIDAR_PWM_FREQ = <span class="number">10000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_PWM_BITS = <span class="number">11</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint8_t</span> LIDAR_PWM_CHANNEL = <span class="number">2</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> LIDAR_SERIAL_RX_BUF_LEN = <span class="number">1024</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> PRINT_EVERY_NTH_POINT = <span class="number">2</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> HEX_DUMP_WIDTH = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"lds_all_models.h"</span></span></span><br><span class="line">LDS *lidar;</span><br><span class="line"><span class="type">uint16_t</span> hex_dump_pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupLidar</span><span class="params">()</span> </span>{</span><br><span class="line"></span><br><span class="line">  lidar = <span class="keyword">new</span> <span class="built_in">LDS_YDLIDAR_X3_PRO</span>();</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  lidar-&gt;<span class="built_in">setScanPointCallback</span>(lidar_scan_point_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setPacketCallback</span>(lidar_packet_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setSerialWriteCallback</span>(lidar_serial_write_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setSerialReadCallback</span>(lidar_serial_read_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setMotorPinCallback</span>(lidar_motor_pin_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setInfoCallback</span>(lidar_info_callback);</span><br><span class="line">  lidar-&gt;<span class="built_in">setErrorCallback</span>(lidar_error_callback);</span><br><span class="line"></span><br><span class="line">  LidarSerial.<span class="built_in">begin</span>(lidar-&gt;<span class="built_in">getSerialBaudRate</span>(), SERIAL_8N1, LIDAR_GPIO_TX, LIDAR_GPIO_RX);</span><br><span class="line"></span><br><span class="line">  lidar-&gt;<span class="built_in">init</span>();</span><br><span class="line">  <span class="comment">//lidar-&gt;stop();</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyBLEServerCallbacks</span> : <span class="keyword">public</span> BLEServerCallbacks</span><br><span class="line">{</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onConnect</span><span class="params">(BLEServer *pServer)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">"connnected!"</span>);</span><br><span class="line">    pServer-&gt;<span class="built_in">getAdvertising</span>()-&gt;<span class="built_in">stop</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">onDisconnect</span><span class="params">(BLEServer *pServer)</span></span></span><br><span class="line"><span class="function">  </span>{</span><br><span class="line">    Serial.<span class="built_in">println</span>(<span class="string">"disconnnected!"</span>);</span><br><span class="line">    pServer-&gt;<span class="built_in">getAdvertising</span>()-&gt;<span class="built_in">start</span>();</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyBLECharacteristicCallbacks</span>: <span class="keyword">public</span> BLECharacteristicCallbacks {</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onWrite</span><span class="params">(BLECharacteristic *pCharacteristic)</span> </span>{</span><br><span class="line">      <span class="comment">// store the data</span></span><br><span class="line">      String rxValue = pCharacteristic-&gt;<span class="built_in">getValue</span>();</span><br><span class="line">      <span class="comment">//if the larger than 0</span></span><br><span class="line">      <span class="keyword">if</span> (rxValue.<span class="built_in">length</span>() &gt; <span class="number">0</span>) {</span><br><span class="line">        Serial.<span class="built_in">println</span>(<span class="string">"*********"</span>);</span><br><span class="line">        Serial.<span class="built_in">print</span>(<span class="string">"Received Value: "</span>);</span><br><span class="line">        <span class="comment">// output the recived information</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; rxValue.<span class="built_in">length</span>(); i++)</span><br><span class="line">          Serial.<span class="built_in">print</span>(rxValue[i]);</span><br><span class="line">        <span class="comment">// start a new line</span></span><br><span class="line">        Serial.<span class="built_in">println</span>();</span><br><span class="line">        Serial.<span class="built_in">println</span>(<span class="string">"*********"</span>);</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onRead</span><span class="params">(BLECharacteristic *pCharacteristic)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">"Client read Characteristic!"</span>);</span><br><span class="line">    } </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onNotify</span><span class="params">(BLECharacteristic *pCharacteristic)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">      Serial.<span class="built_in">println</span>(<span class="string">"Client notify Characteristic!"</span>);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setup</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE1_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE2_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE3_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE4_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE5_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE6_PIN, FREQ, RESOLUTION);</span><br><span class="line">  <span class="built_in">ledcAttach</span>(SHAKE7_PIN, FREQ, RESOLUTION);</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">begin</span>(<span class="number">115200</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(<span class="string">"Starting BLE work!"</span>);</span><br><span class="line"></span><br><span class="line">  BLEDevice::<span class="built_in">init</span>(<span class="string">"ESP32S3 SERVER"</span>);</span><br><span class="line">  BLEServer *pServer = BLEDevice::<span class="built_in">createServer</span>();</span><br><span class="line">  pServer-&gt;<span class="built_in">setCallbacks</span>(<span class="keyword">new</span> <span class="built_in">MyBLEServerCallbacks</span>());</span><br><span class="line"></span><br><span class="line">  BLEService *pService = pServer-&gt;<span class="built_in">createService</span>(SERVICE_UUID);</span><br><span class="line"></span><br><span class="line">  BLECharacteristic *pCharacteristic =</span><br><span class="line">    pService-&gt;<span class="built_in">createCharacteristic</span>(CHARACTERISTIC_UUID, </span><br><span class="line">    BLECharacteristic::PROPERTY_READ | BLECharacteristic::PROPERTY_WRITE|BLECharacteristic::PROPERTY_NOTIFY);</span><br><span class="line"></span><br><span class="line">  pCharacteristic-&gt;<span class="built_in">setCallbacks</span>(<span class="keyword">new</span> MyBLECharacteristicCallbacks);</span><br><span class="line">  <span class="comment">// pCharacteristic-&gt;addDescriptor(new BLE2902());</span></span><br><span class="line">  pCharacteristic-&gt;<span class="built_in">setValue</span>(<span class="string">"Hello World"</span>);</span><br><span class="line">  pService-&gt;<span class="built_in">start</span>();</span><br><span class="line">  <span class="comment">// BLEAdvertising *pAdvertising = pServer-&gt;getAdvertising();  // this still is working for backward compatibility</span></span><br><span class="line">  BLEAdvertising *pAdvertising = BLEDevice::<span class="built_in">getAdvertising</span>();</span><br><span class="line">  pAdvertising-&gt;<span class="built_in">addServiceUUID</span>(SERVICE_UUID);</span><br><span class="line">  pAdvertising-&gt;<span class="built_in">setScanResponse</span>(<span class="literal">true</span>);</span><br><span class="line">  pAdvertising-&gt;<span class="built_in">setMinPreferred</span>(<span class="number">0x00</span>);</span><br><span class="line">  <span class="comment">// pAdvertising-&gt;setMinPreferred(0x06);  // functions that help with iPhone connections issue</span></span><br><span class="line">  <span class="comment">// pAdvertising-&gt;setMinPreferred(0x12);</span></span><br><span class="line">  BLEDevice::<span class="built_in">startAdvertising</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">setupLidar</span>();</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR model "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">getModelName</span>());</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", baud rate "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">getSerialBaudRate</span>());</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", TX GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(LIDAR_GPIO_TX);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", RX GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(LIDAR_GPIO_RX);</span><br><span class="line"></span><br><span class="line">  LDS::<span class="type">result_t</span> result = lidar-&gt;<span class="built_in">start</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"startLidar() result: "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(lidar-&gt;<span class="built_in">resultCodeToString</span>(result));</span><br><span class="line">  <span class="comment">// Set desired rotations-per-second for some LiDAR models</span></span><br><span class="line">  <span class="comment">// lidar-&gt;setScanTargetFreqHz(5.0f);</span></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printByteAsHex</span><span class="params">(<span class="type">uint8_t</span> b)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (b &lt; <span class="number">16</span>)</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">'0'</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(b, HEX);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printBytesAsHex</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> * buffer, <span class="type">uint16_t</span> length)</span> </span>{</span><br><span class="line">  <span class="keyword">if</span> (length == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint16_t</span> i = <span class="number">0</span>; i &lt; length; i++) {</span><br><span class="line">    <span class="built_in">printByteAsHex</span>(buffer[i]);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lidar_serial_read_callback</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_SERIAL_IN</span></span><br><span class="line">  <span class="type">int</span> ch = LidarSerial.<span class="built_in">read</span>();</span><br><span class="line">  <span class="keyword">if</span> (ch != <span class="number">-1</span>) {</span><br><span class="line">    <span class="keyword">if</span> (hex_dump_pos++ % HEX_DUMP_WIDTH == <span class="number">0</span>)</span><br><span class="line">      Serial.<span class="built_in">println</span>();</span><br><span class="line">    <span class="built_in">printByteAsHex</span>(ch);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> ch;</span><br><span class="line">  <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">return</span> LidarSerial.<span class="built_in">read</span>();</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">lidar_serial_write_callback</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> * buffer, <span class="type">size_t</span> length)</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_SERIAL_OUT</span></span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">'&gt;'</span>);</span><br><span class="line">  <span class="built_in">printBytesAsHex</span>(buffer, length);</span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> LidarSerial.<span class="built_in">write</span>(buffer, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_scan_point_callback</span><span class="params">(<span class="type">float</span> angle_deg, <span class="type">float</span> distance_mm, <span class="type">float</span> quality,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="type">bool</span> scan_completed)</span> </span>{</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (scan_completed) {</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"Scan completed; scans-per-second "</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(lidar-&gt;<span class="built_in">getCurrentScanFreqHz</span>());</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i % PRINT_EVERY_NTH_POINT == <span class="number">0</span>) {</span><br><span class="line">    Serial.<span class="built_in">print</span>(i);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(distance_mm);</span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(angle_deg);</span><br><span class="line">  }</span><br><span class="line">  i++;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_motor_pin_callback</span><span class="params">(<span class="type">float</span> value, LDS::<span class="type">lds_pin_t</span> lidar_pin)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pin = (lidar_pin == LDS::LDS_MOTOR_EN_PIN) ? LIDAR_GPIO_EN : LIDAR_GPIO_PWM;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"GPIO "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(pin);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">pinIDToString</span>(lidar_pin));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">" mode set to "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(lidar-&gt;<span class="built_in">pinStateToString</span>((LDS::<span class="type">lds_pin_state_t</span>) <span class="built_in">int</span>(value)));</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value &lt;= (<span class="type">float</span>)LDS::DIR_INPUT) {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configure pin direction</span></span><br><span class="line">    <span class="keyword">if</span> (value == (<span class="type">float</span>)LDS::DIR_OUTPUT_PWM) {</span><br><span class="line"></span><br><span class="line">      <span class="meta">#<span class="keyword">if</span> ESP_IDF_VERSION_MAJOR &lt; 5</span></span><br><span class="line">      <span class="built_in">ledcSetup</span>(LIDAR_PWM_CHANNEL, LIDAR_PWM_FREQ, LIDAR_PWM_BITS);</span><br><span class="line">      <span class="built_in">ledcAttachPin</span>(pin, LIDAR_PWM_CHANNEL);</span><br><span class="line">      <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">ledcAttachChannel</span>(pin, LIDAR_PWM_FREQ, LIDAR_PWM_BITS, LIDAR_PWM_CHANNEL))</span><br><span class="line">        Serial.<span class="built_in">println</span>(<span class="string">"lidar_motor_pin_callback() ledcAttachChannel() error"</span>);</span><br><span class="line">      <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    } <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">pinMode</span>(pin, (value == (<span class="type">float</span>)LDS::DIR_INPUT) ? INPUT : OUTPUT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (value &lt; (<span class="type">float</span>)LDS::VALUE_PWM) {</span><br><span class="line">    <span class="comment">// Set constant output</span></span><br><span class="line">    <span class="comment">// TODO invert PWM as needed</span></span><br><span class="line">    <span class="built_in">digitalWrite</span>(pin, (value == (<span class="type">float</span>)LDS::VALUE_HIGH) ? HIGH : LOW);</span><br><span class="line"></span><br><span class="line">  } <span class="keyword">else</span> {</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">"PWM value set to "</span>);</span><br><span class="line">    Serial.<span class="built_in">print</span>(value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// set PWM duty cycle</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> INVERT_PWM_PIN</span></span><br><span class="line">    value = <span class="number">1</span> - value;</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pwm_value = ((<span class="number">1</span>&lt;&lt;LIDAR_PWM_BITS)<span class="number">-1</span>)*value;</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> ESP_IDF_VERSION_MAJOR &lt; 5</span></span><br><span class="line">    <span class="built_in">ledcWrite</span>(LIDAR_PWM_CHANNEL, pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">ledcWriteChannel</span>(LIDAR_PWM_CHANNEL, pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> DEBUG_GPIO</span></span><br><span class="line">    Serial.<span class="built_in">print</span>(<span class="string">' '</span>);</span><br><span class="line">    Serial.<span class="built_in">println</span>(pwm_value);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_info_callback</span><span class="params">(LDS::<span class="type">info_t</span> code, String info)</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR info "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">infoCodeToString</span>(code));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">": "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(info);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_error_callback</span><span class="params">(LDS::<span class="type">result_t</span> code, String aux_info)</span> </span>{</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"LiDAR error "</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(lidar-&gt;<span class="built_in">resultCodeToString</span>(code));</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">": "</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(aux_info);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lidar_packet_callback</span><span class="params">(<span class="type">uint8_t</span> * packet, <span class="type">uint16_t</span> length, <span class="type">bool</span> scan_completed)</span> </span>{</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG_PACKETS</span></span><br><span class="line">  Serial.<span class="built_in">println</span>();</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">"Packet callback, length="</span>);</span><br><span class="line">  Serial.<span class="built_in">print</span>(length);</span><br><span class="line">  Serial.<span class="built_in">print</span>(<span class="string">", scan_completed="</span>);</span><br><span class="line">  Serial.<span class="built_in">println</span>(scan_completed);</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="comment">// put your main code here, to run repeatedly:</span></span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE1_PIN, <span class="number">255</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE2_PIN, <span class="number">255</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE3_PIN, <span class="number">255</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE4_PIN, <span class="number">255</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE5_PIN, <span class="number">128</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE6_PIN, <span class="number">128</span>);</span><br><span class="line">  <span class="built_in">ledcWrite</span>(SHAKE7_PIN, <span class="number">128</span>);</span><br><span class="line">  lidar-&gt;<span class="built_in">loop</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>



<p>I will keep the code, models, and boards open-source in my GitHub account.</p>
<h2 id="3-Results-Summary"><a href="#3-Results-Summary" class="headerlink" title="3. Results & Summary"></a>3. Results &amp; Summary</h2><p>when building the whole device together, several components were damaged during assembly. Although I consider these things, the total price is about 1200 CNY, which is much less than the price of 9000 EURO. My project may be rough; however, I still believe that there are some methods to lower the price without lowering the quality. </p>
<h3 id="Advantage"><a href="#Advantage" class="headerlink" title="Advantage"></a>Advantage</h3><ol>
<li><p>Low error: according to my measurement, the error is about <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.891ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 1278 666"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="B1" d="M56 320T56 333T70 353H369V502Q369 651 371 655Q376 666 388 666Q402 666 405 654T409 596V500V353H707Q722 345 722 333Q722 320 707 313H409V40H707Q722 32 722 20T707 0H70Q56 7 56 20T70 40H369V313H70Q56 320 56 333Z"></path></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></svg></mjx-container> cm</p>
</li>
<li><p>High range: In some conditions, the radar can even detect objects 9.7m away</p>
</li>
<li><p>Better user experience: vibrations can make users feel the surroundings.</p>
</li>
</ol>
<h3 id="Disadvantage"><a href="#Disadvantage" class="headerlink" title="Disadvantage"></a>Disadvantage</h3><ol>
<li><p>Large weight: The cap is much heavier. Difficult to wear for a long time</p>
</li>
<li><p>High power consumption: The battery needs to be charged frequently.</p>
</li>
</ol>
<h3 id="Project-source-code-and-models-Yiwei-Zheng-GuideCap"><a href="#Project-source-code-and-models-Yiwei-Zheng-GuideCap" class="headerlink" title="Project source code and models: Yiwei-Zheng/GuideCap"></a>Project source code and models: <a target="_blank" rel="noopener" href="https://github.com/Yiwei-Zheng/GuideCap">Yiwei-Zheng/GuideCap</a></h3><h3 id="Video-Presentation-https-youtu-be-Bgd8lBskd0g"><a href="#Video-Presentation-https-youtu-be-Bgd8lBskd0g" class="headerlink" title="Video Presentation https://youtu.be/Bgd8lBskd0g"></a>Video Presentation <a target="_blank" rel="noopener" href="https://youtu.be/Bgd8lBskd0g">https://youtu.be/Bgd8lBskd0g</a></h3>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Invention/" rel="tag"># Invention</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/06/24/HKUSI/" rel="prev" title="HKUSI">
      <i class="fa fa-chevron-left"></i> HKUSI
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/07/26/Some-Interesting-Intergral-Problems-1/" rel="next" title="Some Interesting Intergral Problems(1)">
      Some Interesting Intergral Problems(1) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Background-Intro"><span class="nav-number">1.</span> <span class="nav-text">1. Background &amp; Intro</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-How-I-made-it"><span class="nav-number">2.</span> <span class="nav-text">2. How I made it</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Now-all-the-hardware-is-ready-It-is-time-for-coding"><span class="nav-number">2.1.</span> <span class="nav-text">Now, all the hardware is ready. It is time for coding.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Results-Summary"><span class="nav-number">3.</span> <span class="nav-text">3. Results &amp; Summary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Advantage"><span class="nav-number">3.1.</span> <span class="nav-text">Advantage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Disadvantage"><span class="nav-number">3.2.</span> <span class="nav-text">Disadvantage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Project-source-code-and-models-Yiwei-Zheng-GuideCap"><span class="nav-number">3.3.</span> <span class="nav-text">Project source code and models: Yiwei-Zheng&#x2F;GuideCap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Video-Presentation-https-youtu-be-Bgd8lBskd0g"><span class="nav-number">3.4.</span> <span class="nav-text">Video Presentation https:&#x2F;&#x2F;youtu.be&#x2F;Bgd8lBskd0g</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Yw-Zheng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Yiwei-Zheng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Yiwei-Zheng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yw-Zheng</span>
</div>
<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>
-->

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
